syntax = "proto3";
package lrmrpb;

import "gogoproto/gogo.proto";
import "google/protobuf/empty.proto";
import "lrdd/row.proto";

service Worker {
    rpc CreateTask (CreateTaskRequest) returns (google.protobuf.Empty);
    rpc PushData (stream PushDataRequest) returns (google.protobuf.Empty);
    rpc PollData (stream PollDataRequest) returns (stream PollDataResponse);
}

message CreateTaskRequest {
    string jobID = 1;
    string stageName = 2;

    Input input = 4;
    Output output = 5;
    map<string, bytes> broadcasts = 6;
}

message Input {
    enum Type {
        PUSH = 0;
        POLL = 1;
    }
    Type type = 1;
    string prevStageName = 2;

    // partitionKey is key of this partition.
    string partitionKey = 3;

    // hosts contains an list of hosts providing the partition. Used when type == POLL.
    repeated string hosts = 4;
}

message Output {
    enum Type {
        PUSH = 0;
        POLL = 1;
    }
    Type type = 1;
    string nextStageName = 2;

    enum PartitionerType {
        // Do not shuffle through the network. Output data will be directly fed to next stage using in-memory pipe.
        // Used when input partition is same with output partition.
        PRESERVE = 0;

        // Randomly distribute outputs to next stage.
        SHUFFLE = 1;

        // Distribute output by calculating `hash(row.Key) modulo shardCount.`
        HASH_KEY = 2;

        // Distribute output evenly by predefined partition keys.
        // Can be more effective than HASH_KEY if the keys of output partition are known.
        FINITE_KEY = 3;
    }
    PartitionerType partitioner = 3;

    // partitionKeyToHost contains an ordered mapping of partition key to output hostname.
    map<string, string> partitionToHost = 4;
}

message HostMapping {
    string host = 1;
    string taskID = 2;
}

message CreateTaskResponse {
    string taskID = 1;
}

// PushDataRequest is a request to push data for a worker to process.
// metadata with key "header" and value of DataHeader is required.
message PushDataRequest {
    repeated lrdd.Row data = 1;
}

// PollDataRequest is a request to poll data for a worker to process.
// metadata with key "header" and value of DataHeader is required.
message PollDataRequest {
    // N is maximum number of the data returned.
    int64 n = 1;
}

message PollDataResponse {
    repeated lrdd.Row data = 1;
}

message DataHeader {
    string taskID = 1;
    string fromHost = 2;
    string fromNodeID = 3;
}
